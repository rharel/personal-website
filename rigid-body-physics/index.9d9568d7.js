function t(t,i,e,s,o){let n=null,r=null;function a(){const c=performance.now(),l=null!==r?(c-r)/1e3:1/60;r=c,t.step(l),function(t,i,e,s){i.save(),i.fillStyle=e,i.fillRect(0,0,i.canvas.width,i.canvas.height),i.translate(0,i.canvas.height),i.scale(1,-1),i.scale(i.canvas.width/t.options.size,i.canvas.height/t.options.size);for(const e in s){const{fill:o}=s[e],n=t.entity(parseInt(e));i.beginPath(),i.arc(n.position.x,n.position.y,n.radius,0,2*Math.PI),i.fillStyle=o,i.fill()}i.restore()}(t,i,e,s),o&&o(),null!==n&&(n=requestAnimationFrame(a))}return n=requestAnimationFrame(a),{pause(){null!==n&&(cancelAnimationFrame(n),n=null,r=null)},resume(){null===n&&(r=performance.now(),n=requestAnimationFrame(a))}}}class i{clone(){return new i(this.x,this.y)}assign(t){return this.x=t.x,this.y=t.y,this}normalize(){const t=1/this.length();return this.x*=t,this.y*=t,this}set_length(t){const i=t/this.length();return this.x*=i,this.y*=i,this}add(t){return this.x+=t.x,this.y+=t.y,this}subtract(t){return this.x-=t.x,this.y-=t.y,this}scale(t){return this.x*=t,this.y*=t,this}dot(t){return this.x*t.x+this.y*t.y}length_squared(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}distance_squared_to(t){const i=t.x-this.x,e=t.y-this.y;return i*i+e*e}constructor(t,i){this.x=t,this.y=i}}class e{static from_center_and_radius(t,i,s){return new e(i+s,t-s,s,s)}overlaps(t){return t.left<=this.right&&t.right>=this.left&&t.bottom<=this.top&&t.top>=this.bottom}constructor(t,i,e,s){this.top=t,this.left=i,this.width=e,this.height=s,this.bottom=this.top-this.height,this.right=this.left+this.width}}class s{nr_items(){if("leaf"===this.node.kind)return this.node.items.length;{let t=0;return this.for_each_child((i=>t+=i.nr_items())),t}}clear(){"leaf"===this.node.kind?this.node.items.length=0:this.for_each_child((t=>t.clear()))}add(t,i){i.overlaps(this.bounds)&&("internal"===this.node.kind?this.for_each_child((e=>{e.bounds.overlaps(i)&&e.add(t,i)})):this.node.items.includes(t)||this.node.items.push(t))}remove(t,i){if(i.overlaps(this.bounds))if("internal"===this.node.kind)this.for_each_child((e=>{e.bounds.overlaps(i)&&e.remove(t,i)}));else if(this.node.items.includes(t)){const i=this.node.items.indexOf(t);this.node.items.splice(i,1)}}for_each_child(t){"leaf"!==this.node.kind&&(t(this.node.sw),t(this.node.se),t(this.node.nw),t(this.node.ne))}for_each_leaf_with_at_least(t,i){this.nr_items()<t||("leaf"===this.node.kind?i(this.node.items):this.for_each_child((e=>e.for_each_leaf_with_at_least(t,i))))}constructor(t,i){if(this.depth=t,this.bounds=i,this.node={kind:"leaf",items:[]},this.depth<1)throw new Error("quadtree node cannot have depth < 1");if(1===this.depth)this.node={kind:"leaf",items:[]};else if(this.depth>1){const i=t-1,o=this.bounds.top,n=this.bounds.left,r=.5*this.bounds.width,a=.5*this.bounds.height;this.node={kind:"internal",sw:new s(i,new e(o-a,n,r,a)),se:new s(i,new e(o-a,n+r,r,a)),nw:new s(i,new e(o,n,r,a)),ne:new s(i,new e(o,n+r,r,a))}}}}class o{clear(){this.quadtree.clear()}add(t){this.quadtree.add(t,e.from_center_and_radius(t.position.x,t.position.y,t.radius))}remove(t){this.quadtree.remove(t,e.from_center_and_radius(t.position.x,t.position.y,t.radius))}moved(t,i){const s=e.from_center_and_radius(i.x,i.y,t.radius),o=e.from_center_and_radius(t.position.x,t.position.y,t.radius);this.quadtree.remove(t,s),this.quadtree.add(t,o)}for_each_potential_collision_group(t){this.quadtree.for_each_leaf_with_at_least(2,(i=>{t(i)}))}constructor(t){this.options=t,this.quadtree=new s(t.subdivisions,new e(t.bounds_size,0,t.bounds_size,t.bounds_size))}}function n(t,i,e,s,o,n){const r=i.x-o.x,a=i.y-o.y,c=r*r,l=a*a,h=t.x-s.x,d=t.y-s.y,u=function(t,i,e){const s=i*i-4*t*e;return s<0?{count:0}:s>0?{count:2,x1:(-i+Math.sqrt(s))/(2*t),x2:(-i-Math.sqrt(s))/(2*t)}:{count:1,x1:-i/(2*t)}}(c+l,2*(h*r+d*a),h*h+d*d-(e+n)*(e+n));if(2===u.count){const[t,i]=u.x1<=u.x2?[u.x1,u.x2]:[u.x2,u.x1];return t<0&&i>=0?0:t}return 1===u.count?u.x1:-1}function r(t,i){let e=[];for(let s=0;s<t.length;++s){const o=t[s];for(let r=s+1;r<t.length;++r){const s=t[r];if(o.static&&s.static)continue;const a=n(o.position,o.velocity,o.radius,s.position,s.velocity,s.radius);0<=a&&a<=i&&e.push({entities:[o,s],time:a})}}return e}function a(t){const i=[];for(let r=0;r<t.length;++r){const a=t[r];for(let c=r+1;c<t.length;++c){const r=t[c];if((!a.static||!r.static)&&(e=a.position,s=a.radius,o=r.position,n=r.radius,e.distance_squared_to(o)<=(s+n)*(s+n))){i.push([a,r]);break}}}var e,s,o,n;return i}function c(t,i){if(t.static&&i.static)return;if(i.static){const e=t;t=i,i=e}const e=t.position.clone().subtract(i.position).set_length(t.radius+i.radius),s=t.velocity.clone().subtract(i.velocity),o=2*(.5*(t.elasticity+i.elasticity))*s.dot(e)/((t.mass+i.mass)*e.length_squared());t.static||t.velocity.subtract(e.clone().scale(o*i.mass)),i.static||i.velocity.subtract(e.clone().scale(-o*t.mass))}function l(t,i,e){if(t.static&&i.static)return;const s=t.radius+i.radius+e,o=t.position.distance_squared_to(i.position);if(o>=s*s)return;const n=t.position.clone().subtract(i.position).normalize(),r=s-Math.sqrt(o);t.static?i.position.add(n.scale(-r)):i.static?t.position.add(n.scale(r)):(t.position.add(n.clone().scale(.5*r)),i.position.add(n.clone().scale(.5*-r)))}const h=Math.pow(10,14);function d(t,i){const e=t.applied_force,s=1/t.mass,o=t.position,n=t.velocity,r=.5*i*s;o.x+=i*(n.x+r*e.x),o.y+=i*(n.y+r*e.y);const a=i*s;n.x+=a*e.x,n.y+=a*e.y}class u{clear(){this.collision_culler.clear(),this.entities.clear()}spawn(t){const e={mass:t.static?h:void 0!==t.mass?t.mass:1,radius:void 0!==t.radius?t.radius:1,elasticity:void 0!==t.elasticity?t.elasticity:0,static:void 0!==t.static&&t.static,position:void 0!==t.position?new i(t.position.x,t.position.y):new i(0,0),velocity:void 0!==t.velocity?new i(t.velocity.x,t.velocity.y):new i(0,0),applied_force:void 0!==t.applied_force?new i(t.applied_force.x,t.applied_force.y):new i(0,0)},s=this.next_entity_id;return this.next_entity_id+=1,this.entities.set(s,e),this.collision_culler.add(e),s}remove(t){if(!this.entities.has(t))throw new Error("bad entity id");const i=this.entities.get(t);this.collision_culler.remove(i),this.entities.delete(t)}entity(t){if(!this.entities.has(t))throw new Error("bad entity id");const i=this.entities.get(t);return{...i,position:{x:i.position.x,y:i.position.y},velocity:{x:i.velocity.x,y:i.velocity.y},applied_force:{x:i.applied_force.x,y:i.applied_force.y}}}update(t,i){if(!this.entities.has(t))throw new Error("bad entity id");const e=this.entities.get(t),s=e.position.clone();void 0!==i.mass&&(e.mass=i.mass),void 0!==i.radius&&(e.radius=i.radius),void 0!==i.elasticity&&(e.elasticity=i.elasticity),void 0!==i.static&&(e.static=i.static,e.static&&(e.mass=h)),void 0!==i.position&&(e.position.x=i.position.x,e.position.y=i.position.y),void 0!==i.velocity&&(e.velocity.x=i.velocity.x,e.velocity.y=i.velocity.y),void 0!==i.applied_force&&(e.applied_force.x=i.applied_force.x,e.applied_force.y=i.applied_force.y),void 0===i.position&&void 0===i.radius||this.collision_culler.moved(e,s)}for_each_entity(t){this.entities.forEach(((i,e)=>{t(e,this.entity(e))}))}step(t){if(t<=0)throw new Error("cannot step with dt <= 0");this.separate_colliding_entities(),this.options.high_precision?this.step_with_high_precision(t):this.step_with_low_precision(t),this.entities.forEach((t=>{t.velocity.length_squared()<.001&&(t.velocity.x=0,t.velocity.y=0)}))}separate_colliding_entities(){const t=new Map;this.collision_culler.for_each_potential_collision_group((i=>{let e=a(i);for(;e.length>0;){for(const[i,s]of e)i.static||t.set(i,i.position.clone()),s.static||t.set(s,s.position.clone()),l(i,s,.001),c(i,s);e=a(i)}})),t.forEach(((t,i)=>{this.collision_culler.moved(i,t)}))}step_with_high_precision(t){const i=new Set,e=new Map;this.entities.forEach((t=>{e.set(t,t.position.clone())})),this.collision_culler.for_each_potential_collision_group((e=>{for(let t=0;t<e.length;++t)i.add(e[t]);this.step_entity_group(e,t)})),this.entities.forEach((e=>{i.has(e)||d(e,t)})),e.forEach(((t,i)=>{this.collision_culler.moved(i,t)}))}step_entity_group(t,i){let e=i;for(;e>.001;){let s=null;for(const i of r(t,e))(null===s||i.time<s.time)&&(s=i);const o=null!==s?s.time:i;for(const i of t)d(i,o);null!==s&&(c(s.entities[0],s.entities[1]),l(s.entities[0],s.entities[1],.001)),e-=o}}step_with_low_precision(t){this.entities.forEach((i=>{if(!i.static){const e=i.position.clone();d(i,t),this.collision_culler.moved(i,e)}}))}constructor(t){this.options=t,this.next_entity_id=0,this.entities=new Map,this.collision_culler=new o({subdivisions:t.collision_culling_subdivisions,bounds_size:t.size})}}const p=["red","blue","brown","green","orange","magenta","purple"];function _(t,i){return t+Math.random()*(i-t)}window.addEventListener("DOMContentLoaded",(function(){const e={},s=new u({size:1,collision_culling_subdivisions:3,high_precision:!0});for(let t=0;t<50;++t){const o=_(.012,.03),n=Math.PI*o*o;e[s.spawn({mass:n,radius:o,elasticity:.95,position:{x:_(o,s.options.size-o),y:_(o,s.options.size-o)},velocity:new i(_(-1,1),_(-1,1)).set_length(_(.1,.5))})]={fill:p[t%p.length]}}const o=document.getElementsByClassName("demo-canvas");if(1!==o.length)throw new Error(`expected 1 demo canvas, found ${o.length}`);const n=o.item(0);if(!(n instanceof HTMLCanvasElement))throw new Error("expected canvas element, found "+typeof n);const r=n.getContext("2d",{alpha:!1});if(null===r)throw new Error("cannot get rendering context");const a=window.matchMedia("(prefers-color-scheme: dark)").matches?"black":"white",c=t(s,r,a,e,(()=>{let t=0;s.for_each_entity(((i,e)=>{let o=!1;e.position.x<e.radius&&(e.position.x=e.radius,e.velocity.x*=-1,o=!0),e.position.x>s.options.size-e.radius&&(e.position.x=s.options.size-e.radius,e.velocity.x*=-1,o=!0),e.position.y<e.radius&&(e.position.y=e.radius,e.velocity.y*=-1,o=!0),e.position.y>s.options.size-e.radius&&(e.position.y=s.options.size-e.radius,e.velocity.y*=-1,o=!0),o&&s.update(i,{position:e.position,velocity:e.velocity}),t+=e.velocity.x+e.velocity.y})),0===t&&c.pause()}))}));
//# sourceMappingURL=index.9d9568d7.js.map
